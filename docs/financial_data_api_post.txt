# API de Financial Data - Método POST

## Endpoint

**POST** `/api/v1/financials/data/`

Cria uma transação financeira a partir de um item financeiro (bill, income, recurring_bill_payment, recurring_income_receipt).

---

## Autenticação

Requer autenticação JWT e identificação da empresa ativa.

**Headers obrigatórios:**
```
Authorization: Bearer <access_token>
X-Company-Id: <company_id>
```

Ou usar cookies de autenticação:
```
Cookie: access_token=<access_token>; company_access_token=<company_token>
```

---

## Body da Requisição

### Campos Obrigatórios

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `uuid` | UUID | UUID do item financeiro (bill, income, recurring_bill_payment ou recurring_income_receipt). Deve pertencer à empresa ativa. | `"90764fed-4ba7-4e0b-9609-68c94d7184c6"` |
| `type` | string | Tipo do item. Valores aceitos: `bills`, `incomes`, `recurring_bill_payments`, `recurring_income_receipts` | `"bills"` |
| `bank_account` | UUID | UUID da conta bancária onde a transação será registrada. Deve pertencer à empresa ativa. | `"8d2bd953-a203-4c63-901d-75e9a93ae00a"` |
| `transaction_date` | date (YYYY-MM-DD) | Data da transação. Usado para `paid_on` (payments) e `received_on` (receipts). | `"2025-12-03"` |

### Campos Opcionais

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `description` | string | Descrição personalizada da transação. Se não fornecida, será gerada automaticamente com base no tipo e descrição do item | `"Pagamento via PIX"` |
| `payment_method` | UUID | UUID do método de pagamento (obtido através da API `/api/v1/financials/payment-methods/`). Opcional. | `"c32ebfed-fe56-4f84-98e3-5580c14e1241"` |

---

## Validações

### Validações Gerais

1. **Item deve existir**: O UUID fornecido deve corresponder a um item válido da empresa ativa
2. **Item não pode estar quitado/recebido**: 
   - Bills: não pode estar com status `quitada`
   - Incomes: não pode estar com status `recebido`
   - RecurringBillPayments: não pode estar com status `quitada`
   - RecurringIncomeReceipts: não pode estar com status `recebido`
3. **Item não pode ter transação existente**: O item não pode já possuir uma transação associada
4. **Conta bancária deve pertencer à empresa**: A conta bancária fornecida deve pertencer à empresa ativa

### Validações por Tipo

- **Bills**: Verifica se `status != QUITADA` e se `payment_transaction == null`
- **Incomes**: Verifica se `status != RECEBIDO` e se `payment_transaction == null`
- **RecurringBillPayments**: Verifica se `status != QUITADA` e se `transaction == null`
- **RecurringIncomeReceipts**: Verifica se `status != RECEBIDO` e se `transaction == null`

---

## Comportamento

### Pré-preenchimento Automático

A transação é criada com dados pré-preenchidos do item selecionado:

#### Para Bills e Incomes:
- **Categoria**: Copiada do item (`item.category`)
- **Centro de Custo**: Copiado do item (`item.cost_center`)
- **Contato**: Copiado do item (`item.contact`) - apenas para bills e incomes
- **Valor**: Copiado do item (`item.amount`)
- **Tipo de Transação**: 
  - `DESPESA` para bills
  - `RECEITA` para incomes

#### Para RecurringBillPayments e RecurringIncomeReceipts:
- **Categoria**: Copiada do recurring_bill/recurring_income pai (`item.recurring_bill.category` ou `item.recurring_income.category`)
- **Centro de Custo**: Copiado do recurring_bill/recurring_income pai (`item.recurring_bill.cost_center` ou `item.recurring_income.cost_center`)
- **Contato**: Copiado do recurring_bill/recurring_income pai (`item.recurring_bill.contact` ou `item.recurring_income.contact`) - se existir
- **Valor**: Copiado do item (`item.amount`)
- **Tipo de Transação**:
  - `DESPESA` para recurring_bill_payments
  - `RECEITA` para recurring_income_receipts

### Descrição Automática

Se `description` não for fornecida, será gerada automaticamente:
- Bills: `"Pagamento - {item.description}"`
- Incomes: `"Recebimento - {item.description}"`
- RecurringBillPayments: `"Pagamento - {item.recurring_bill.description}"`
- RecurringIncomeReceipts: `"Recebimento - {item.recurring_income.description}"`

### Atualização Automática do Item

Após criar a transação, o item é automaticamente atualizado:

#### Bills:
- `payment_transaction` = transação criada
- `status` = `QUITADA`
- `updated_at` = agora

#### Incomes:
- `payment_transaction` = transação criada
- `status` = `RECEBIDO`
- `updated_at` = agora

#### RecurringBillPayments:
- `transaction` = transação criada
- `status` = `QUITADA`
- `paid_on` = `transaction_date`
- `updated_at` = agora

#### RecurringIncomeReceipts:
- `transaction` = transação criada
- `status` = `RECEBIDO`
- `received_on` = `transaction_date`
- `updated_at` = agora

### Atualização do Saldo Bancário

O `current_balance` da conta bancária é **automaticamente atualizado** quando a transação é criada:
- **Receitas** (`RECEITA`): Adiciona o valor ao saldo (`+amount`)
- **Despesas** (`DESPESA`): Subtrai o valor do saldo (`-amount`)

Esta atualização é feita automaticamente pelo método `save()` do modelo `Transaction` através de `_sync_bank_account_balance()`.

---

## Resposta de Sucesso

**Status Code:** `201 Created`

A resposta retorna a mesma estrutura do GET com `uuid`, incluindo:
- `type`: Tipo do item
- `item`: Dados completos do item atualizado
- Campos adicionais dependendo do tipo:
  - `payment_transaction`: Para bills/incomes (obrigatório após criação)
  - `transaction`: Para recurring_bill_payments/recurring_income_receipts (obrigatório após criação)

### Exemplo de Resposta - Bill

```json
{
    "type": "bills",
    "item": {
        "id": "90764fed-4ba7-4e0b-9609-68c94d7184c6",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "1e28c820-e5c4-402e-a94a-5a8c9b8e7da5",
        "cost_center_name": "Administracao",
        "contact": null,
        "contact_name": null,
        "payment_transaction": "805f706a-3e8e-4fbb-a981-8cae9436020d",
        "description": "Aluguel",
        "amount": "2000.00",
        "due_date": "2025-12-13",
        "status": "quitada",
        "created_at": "2025-11-28T12:39:31.620065-03:00",
        "updated_at": "2025-12-03T15:08:44.381518-03:00"
    },
    "payment_transaction": {
        "id": "805f706a-3e8e-4fbb-a981-8cae9436020d",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "1e28c820-e5c4-402e-a94a-5a8c9b8e7da5",
        "cost_center_name": "Administracao",
        "contact": null,
        "contact_name": null,
        "payment_method": null,
        "payment_method_name": null,
        "description": "Teste de pagamento via API",
        "amount": "2000.00",
        "type": "despesa",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:08:44.376917-03:00",
        "updated_at": "2025-12-03T15:08:44.376926-03:00"
    }
}
```

### Exemplo de Resposta - Income

```json
{
    "type": "incomes",
    "item": {
        "id": "uuid-do-income",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo",
        "payment_transaction": "uuid-da-transacao",
        "description": "Venda de produto",
        "amount": "1500.00",
        "due_date": "2025-12-10",
        "status": "recebido",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "payment_transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo",
        "payment_method": "c32ebfed-fe56-4f84-98e3-5580c14e1241",
        "payment_method_name": "Pix",
        "description": "Recebimento - Venda de produto",
        "amount": "1500.00",
        "type": "receita",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

### Exemplo de Resposta - RecurringBillPayment

```json
{
    "type": "recurring_bill_payments",
    "item": {
        "id": "uuid-do-payment",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "recurring_bill": "uuid-do-recurring-bill",
        "recurring_bill_description": "Assinatura mensal - Software",
        "category_code": "2",
        "category_name": "Despesas Operacionais",
        "contact_name": "Fornecedor Exemplo LTDA",
        "transaction": "uuid-da-transacao",
        "due_date": "2025-12-10",
        "paid_on": "2025-12-03",
        "amount": "299.00",
        "status": "quitada",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Administracao",
        "contact": "uuid-do-contato",
        "contact_name": "Fornecedor Exemplo LTDA",
        "payment_method": "809f3d50-026a-4ec2-8efc-e642b384eaf2",
        "payment_method_name": "Boleto",
        "description": "Pagamento - Assinatura mensal - Software",
        "amount": "299.00",
        "type": "despesa",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

### Exemplo de Resposta - RecurringIncomeReceipt

```json
{
    "type": "recurring_income_receipts",
    "item": {
        "id": "uuid-do-receipt",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "recurring_income": "uuid-do-recurring-income",
        "recurring_income_description": "Aluguel recebido - Sala comercial",
        "category_code": "1",
        "category_name": "Vendas",
        "contact_name": "Cliente Exemplo LTDA",
        "transaction": "uuid-da-transacao",
        "due_date": "2025-12-10",
        "received_on": "2025-12-03",
        "amount": "5000.00",
        "status": "recebido",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo LTDA",
        "payment_method": "c32ebfed-fe56-4f84-98e3-5580c14e1241",
        "payment_method_name": "Pix",
        "description": "Recebimento - Aluguel recebido - Sala comercial",
        "amount": "5000.00",
        "type": "receita",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

---

## Respostas de Erro

### 400 Bad Request - Tipo Inválido

```json
{
    "error": "Tipo 'invalid_type' inválido.",
    "valid_types": ["bills", "incomes", "recurring_bill_payments", "recurring_income_receipts"]
}
```

### 400 Bad Request - Item Já Quitado/Recebido

**Para Bills:**
```json
{
    "error": "Esta conta já foi quitada."
}
```

**Para Incomes:**
```json
{
    "error": "Esta conta já foi recebida."
}
```

**Para RecurringBillPayments:**
```json
{
    "error": "Este pagamento já foi quitado."
}
```

**Para RecurringIncomeReceipts:**
```json
{
    "error": "Este recebimento já foi recebido."
}
```

### 400 Bad Request - Item Já Possui Transação

**Para Bills:**
```json
{
    "error": "Esta conta já possui uma transação de pagamento."
}
```

**Para Incomes:**
```json
{
    "error": "Esta conta já possui uma transação de recebimento."
}
```

**Para RecurringBillPayments:**
```json
{
    "error": "Este pagamento já possui uma transação."
}
```

**Para RecurringIncomeReceipts:**
```json
{
    "error": "Este recebimento já possui uma transação."
}
```

### 404 Not Found - Item Não Encontrado

```json
{
    "error": "Item não encontrado com UUID: {uuid}"
}
```

### 400 Bad Request - Validação do Serializer

```json
{
    "uuid": ["Este campo é obrigatório."],
    "type": ["Este campo é obrigatório."],
    "bank_account": ["Este campo é obrigatório."],
    "transaction_date": ["Este campo é obrigatório."]
}
```

---

## Exemplos de Uso

### Exemplo 1: Criar Transação para Bill

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "90764fed-4ba7-4e0b-9609-68c94d7184c6",
    "type": "bills",
    "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
    "transaction_date": "2025-12-03",
    "description": "Pagamento via PIX",
    "payment_method": "uuid-do-metodo-pagamento"
  }'
```

**Resultado:**
- Transação criada com tipo `DESPESA`
- Bill atualizado para status `quitada`
- Saldo da conta bancária reduzido pelo valor do bill

### Exemplo 2: Criar Transação para Income

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-income",
    "type": "incomes",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03"
  }'
```

**Resultado:**
- Transação criada com tipo `RECEITA`
- Income atualizado para status `recebido`
- Descrição automática: `"Recebimento - {income.description}"`
- Saldo da conta bancária aumentado pelo valor do income

### Exemplo 3: Criar Transação para RecurringBillPayment

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-payment",
    "type": "recurring_bill_payments",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03"
  }'
```

**Resultado:**
- Transação criada com tipo `DESPESA`
- RecurringBillPayment atualizado para status `quitada`
- Campo `paid_on` preenchido com `transaction_date`
- Categoria, centro de custo e contato copiados do `recurring_bill` pai
- Saldo da conta bancária reduzido pelo valor do payment

### Exemplo 4: Criar Transação para RecurringIncomeReceipt

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-receipt",
    "type": "recurring_income_receipts",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03",
    "description": "Recebimento antecipado"
  }'
```

**Resultado:**
- Transação criada com tipo `RECEITA`
- RecurringIncomeReceipt atualizado para status `recebido`
- Campo `received_on` preenchido com `transaction_date`
- Categoria, centro de custo e contato copiados do `recurring_income` pai
- Saldo da conta bancária aumentado pelo valor do receipt

---

## Notas Importantes

1. **Operação Atômica**: A criação da transação e atualização do item são feitas em uma transação atômica do banco de dados. Se qualquer parte falhar, tudo é revertido.

2. **Atualização Automática de Saldo**: O saldo da conta bancária é atualizado automaticamente quando a transação é criada. Não é necessário fazer chamadas adicionais.

3. **Pré-preenchimento Inteligente**: Todos os dados relevantes (categoria, centro de custo, contato, valor) são copiados automaticamente do item ou do item pai (para recurring payments/receipts), facilitando o processo de criação.

4. **Validações de Negócio**: O endpoint valida se o item pode receber uma transação (não está quitado/recebido e não possui transação existente).

5. **Descrição Padrão**: Se não fornecida, a descrição é gerada automaticamente com base no tipo e descrição do item.

6. **Suporte a Método de Pagamento**: É possível especificar um método de pagamento opcional, que será associado à transação.

7. **Resposta Completa**: A resposta inclui tanto o item atualizado quanto a transação criada, facilitando a atualização do frontend.

---

## Fluxo Completo

1. **Validação de Autenticação**: Verifica se o usuário está autenticado e pertence à empresa
2. **Validação de Dados**: Valida os campos obrigatórios e formato dos dados
3. **Busca do Item**: Busca o item financeiro pelo UUID
4. **Validação de Estado**: Verifica se o item pode receber uma transação
5. **Extração de Dados**: Extrai dados do item para pré-preencher a transação
6. **Criação da Transação**: Cria a transação com dados pré-preenchidos
7. **Atualização do Saldo**: O saldo bancário é atualizado automaticamente
8. **Atualização do Item**: Atualiza o status e associa a transação ao item
9. **Resposta**: Retorna o item atualizado com a transação criada

---

## Integração com Frontend

### Fluxo Sugerido

1. **Listar Itens Pendentes**: Usar GET `/api/v1/financials/data/?type=bills&status=a_vencer`
2. **Selecionar Item**: Usuário seleciona um item da lista
3. **Abrir Modal/Form**: Mostrar formulário com:
   - Conta bancária (dropdown)
   - Data da transação (date picker)
   - Descrição (opcional, com valor padrão)
   - Método de pagamento (opcional)
4. **Submeter POST**: Enviar requisição POST com os dados
5. **Atualizar UI**: 
   - Atualizar o item na lista (status mudou para quitada/recebido)
   - Mostrar transação criada
   - Atualizar saldo da conta bancária

### Tratamento de Erros

- **Item já quitado**: Mostrar mensagem e remover da lista de pendentes
- **Item não encontrado**: Mostrar erro e recarregar lista
- **Validação falhou**: Mostrar erros de validação nos campos correspondentes

---

## Testes

Para testar o endpoint, execute o script:
```bash
./test_financial_data_api.sh
```

O script realiza:
1. Login e obtenção de tokens
2. Listagem de bills pendentes
3. Criação de transação para um bill
4. Verificação de atualização de saldo
5. Validação de resposta

