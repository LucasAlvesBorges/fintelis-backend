# API de Financial Data - Método POST

## Endpoint

**POST** `/api/v1/financials/data/`

Cria uma transação financeira a partir de um item financeiro (bill, income, recurring_bill_payment, recurring_income_receipt).

---

## Autenticação

Requer autenticação JWT e identificação da empresa ativa.

**Headers obrigatórios:**
```
Authorization: Bearer <access_token>
X-Company-Id: <company_id>
```

Ou usar cookies de autenticação:
```
Cookie: access_token=<access_token>; company_access_token=<company_token>
```

---

## Body da Requisição

### Campos Obrigatórios

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `uuid` | UUID | UUID do item financeiro (bill, income, recurring_bill_payment ou recurring_income_receipt). Deve pertencer à empresa ativa. | `"90764fed-4ba7-4e0b-9609-68c94d7184c6"` |
| `type` | string | Tipo do item. Valores aceitos: `bills`, `incomes`, `recurring_bill_payments`, `recurring_income_receipts` | `"bills"` |
| `bank_account` | UUID | UUID da conta bancária onde a transação será registrada. Deve pertencer à empresa ativa. | `"8d2bd953-a203-4c63-901d-75e9a93ae00a"` |
| `transaction_date` | date (YYYY-MM-DD) | Data da transação. Usado para `paid_on` (payments) e `received_on` (receipts). | `"2025-12-03"` |

### Campos Opcionais

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `description` | string | Descrição personalizada da transação. Se não fornecida, será gerada automaticamente com base no tipo e descrição do item | `"Pagamento via PIX"` |
| `payment_method` | UUID | UUID do método de pagamento (obtido através da API `/api/v1/financials/payment-methods/`). Opcional. | `"c32ebfed-fe56-4f84-98e3-5580c14e1241"` |

---

## Validações

### Validações Gerais

1. **Item deve existir**: O UUID fornecido deve corresponder a um item válido da empresa ativa
2. **Item não pode estar quitado/recebido**: 
   - Bills: não pode estar com status `quitada`
   - Incomes: não pode estar com status `recebido`
   - RecurringBillPayments: não pode estar com status `quitada`
   - RecurringIncomeReceipts: não pode estar com status `recebido`
3. **Item não pode ter transação existente**: O item não pode já possuir uma transação associada
4. **Conta bancária deve pertencer à empresa**: A conta bancária fornecida deve pertencer à empresa ativa

### Validações por Tipo

- **Bills**: Verifica se `status != QUITADA` e se `payment_transaction == null`
- **Incomes**: Verifica se `status != RECEBIDO` e se `payment_transaction == null`
- **RecurringBillPayments**: Verifica se `status != QUITADA` e se `transaction == null`
- **RecurringIncomeReceipts**: Verifica se `status != RECEBIDO` e se `transaction == null`

---

## Comportamento

### Pré-preenchimento Automático

A transação é criada com dados pré-preenchidos do item selecionado:

#### Para Bills e Incomes:
- **Categoria**: Copiada do item (`item.category`)
- **Centro de Custo**: Copiado do item (`item.cost_center`)
- **Contato**: Copiado do item (`item.contact`) - apenas para bills e incomes
- **Valor**: Copiado do item (`item.amount`)
- **Tipo de Transação**: 
  - `DESPESA` para bills
  - `RECEITA` para incomes

#### Para RecurringBillPayments e RecurringIncomeReceipts:
- **Categoria**: Copiada do recurring_bill/recurring_income pai (`item.recurring_bill.category` ou `item.recurring_income.category`)
- **Centro de Custo**: Copiado do recurring_bill/recurring_income pai (`item.recurring_bill.cost_center` ou `item.recurring_income.cost_center`)
- **Contato**: Copiado do recurring_bill/recurring_income pai (`item.recurring_bill.contact` ou `item.recurring_income.contact`) - se existir
- **Valor**: Copiado do item (`item.amount`)
- **Tipo de Transação**:
  - `DESPESA` para recurring_bill_payments
  - `RECEITA` para recurring_income_receipts

### Descrição Automática

Se `description` não for fornecida, será gerada automaticamente:
- Bills: `"Pagamento - {item.description}"`
- Incomes: `"Recebimento - {item.description}"`
- RecurringBillPayments: `"Pagamento - {item.recurring_bill.description}"`
- RecurringIncomeReceipts: `"Recebimento - {item.recurring_income.description}"`

### Atualização Automática do Item

Após criar a transação, o item é automaticamente atualizado:

#### Bills:
- `payment_transaction` = transação criada
- `status` = `QUITADA`
- `updated_at` = agora

#### Incomes:
- `payment_transaction` = transação criada
- `status` = `RECEBIDO`
- `updated_at` = agora

#### RecurringBillPayments:
- `transaction` = transação criada
- `status` = `QUITADA`
- `paid_on` = `transaction_date`
- `updated_at` = agora

#### RecurringIncomeReceipts:
- `transaction` = transação criada
- `status` = `RECEBIDO`
- `received_on` = `transaction_date`
- `updated_at` = agora

### Atualização do Saldo Bancário

O `current_balance` da conta bancária é **automaticamente atualizado** quando a transação é criada:
- **Receitas** (`RECEITA`): Adiciona o valor ao saldo (`+amount`)
- **Despesas** (`DESPESA`): Subtrai o valor do saldo (`-amount`)

Esta atualização é feita automaticamente pelo método `save()` do modelo `Transaction` através de `_sync_bank_account_balance()`.

---

## Resposta de Sucesso

**Status Code:** `201 Created`

A resposta retorna a mesma estrutura do GET com `uuid`, incluindo:
- `type`: Tipo do item
- `item`: Dados completos do item atualizado
- Campos adicionais dependendo do tipo:
  - `payment_transaction`: Para bills/incomes (obrigatório após criação)
  - `transaction`: Para recurring_bill_payments/recurring_income_receipts (obrigatório após criação)

### Exemplo de Resposta - Bill

```json
{
    "type": "bills",
    "item": {
        "id": "90764fed-4ba7-4e0b-9609-68c94d7184c6",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "1e28c820-e5c4-402e-a94a-5a8c9b8e7da5",
        "cost_center_name": "Administracao",
        "contact": null,
        "contact_name": null,
        "payment_transaction": "805f706a-3e8e-4fbb-a981-8cae9436020d",
        "description": "Aluguel",
        "amount": "2000.00",
        "due_date": "2025-12-13",
        "status": "quitada",
        "created_at": "2025-11-28T12:39:31.620065-03:00",
        "updated_at": "2025-12-03T15:08:44.381518-03:00"
    },
    "payment_transaction": {
        "id": "805f706a-3e8e-4fbb-a981-8cae9436020d",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "1e28c820-e5c4-402e-a94a-5a8c9b8e7da5",
        "cost_center_name": "Administracao",
        "contact": null,
        "contact_name": null,
        "payment_method": null,
        "payment_method_name": null,
        "description": "Teste de pagamento via API",
        "amount": "2000.00",
        "type": "despesa",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:08:44.376917-03:00",
        "updated_at": "2025-12-03T15:08:44.376926-03:00"
    }
}
```

### Exemplo de Resposta - Income

```json
{
    "type": "incomes",
    "item": {
        "id": "uuid-do-income",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo",
        "payment_transaction": "uuid-da-transacao",
        "description": "Venda de produto",
        "amount": "1500.00",
        "due_date": "2025-12-10",
        "status": "recebido",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "payment_transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo",
        "payment_method": "c32ebfed-fe56-4f84-98e3-5580c14e1241",
        "payment_method_name": "Pix",
        "description": "Recebimento - Venda de produto",
        "amount": "1500.00",
        "type": "receita",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

### Exemplo de Resposta - RecurringBillPayment

```json
{
    "type": "recurring_bill_payments",
    "item": {
        "id": "uuid-do-payment",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "recurring_bill": "uuid-do-recurring-bill",
        "recurring_bill_description": "Assinatura mensal - Software",
        "category_code": "2",
        "category_name": "Despesas Operacionais",
        "contact_name": "Fornecedor Exemplo LTDA",
        "transaction": "uuid-da-transacao",
        "due_date": "2025-12-10",
        "paid_on": "2025-12-03",
        "amount": "299.00",
        "status": "quitada",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Administracao",
        "contact": "uuid-do-contato",
        "contact_name": "Fornecedor Exemplo LTDA",
        "payment_method": "809f3d50-026a-4ec2-8efc-e642b384eaf2",
        "payment_method_name": "Boleto",
        "description": "Pagamento - Assinatura mensal - Software",
        "amount": "299.00",
        "type": "despesa",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

### Exemplo de Resposta - RecurringIncomeReceipt

```json
{
    "type": "recurring_income_receipts",
    "item": {
        "id": "uuid-do-receipt",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "recurring_income": "uuid-do-recurring-income",
        "recurring_income_description": "Aluguel recebido - Sala comercial",
        "category_code": "1",
        "category_name": "Vendas",
        "contact_name": "Cliente Exemplo LTDA",
        "transaction": "uuid-da-transacao",
        "due_date": "2025-12-10",
        "received_on": "2025-12-03",
        "amount": "5000.00",
        "status": "recebido",
        "created_at": "2025-11-28T12:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    },
    "transaction": {
        "id": "uuid-da-transacao",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
        "bank_account_name": "Conta Principal",
        "category": "uuid-da-categoria",
        "category_name": "Vendas",
        "category_code": "1",
        "cost_center": "uuid-do-centro-custo",
        "cost_center_name": "Comercial",
        "contact": "uuid-do-contato",
        "contact_name": "Cliente Exemplo LTDA",
        "payment_method": "c32ebfed-fe56-4f84-98e3-5580c14e1241",
        "payment_method_name": "Pix",
        "description": "Recebimento - Aluguel recebido - Sala comercial",
        "amount": "5000.00",
        "type": "receita",
        "transaction_date": "2025-12-03",
        "created_at": "2025-12-03T15:00:00-03:00",
        "updated_at": "2025-12-03T15:00:00-03:00"
    }
}
```

---

## Respostas de Erro

### 400 Bad Request - Tipo Inválido

```json
{
    "error": "Tipo 'invalid_type' inválido.",
    "valid_types": ["bills", "incomes", "recurring_bill_payments", "recurring_income_receipts"]
}
```

### 400 Bad Request - Item Já Quitado/Recebido

**Para Bills:**
```json
{
    "error": "Esta conta já foi quitada."
}
```

**Para Incomes:**
```json
{
    "error": "Esta conta já foi recebida."
}
```

**Para RecurringBillPayments:**
```json
{
    "error": "Este pagamento já foi quitado."
}
```

**Para RecurringIncomeReceipts:**
```json
{
    "error": "Este recebimento já foi recebido."
}
```

### 400 Bad Request - Item Já Possui Transação

**Para Bills:**
```json
{
    "error": "Esta conta já possui uma transação de pagamento."
}
```

**Para Incomes:**
```json
{
    "error": "Esta conta já possui uma transação de recebimento."
}
```

**Para RecurringBillPayments:**
```json
{
    "error": "Este pagamento já possui uma transação."
}
```

**Para RecurringIncomeReceipts:**
```json
{
    "error": "Este recebimento já possui uma transação."
}
```

### 404 Not Found - Item Não Encontrado

```json
{
    "error": "Item não encontrado com UUID: {uuid}"
}
```

### 400 Bad Request - Validação do Serializer

```json
{
    "uuid": ["Este campo é obrigatório."],
    "type": ["Este campo é obrigatório."],
    "bank_account": ["Este campo é obrigatório."],
    "transaction_date": ["Este campo é obrigatório."]
}
```

---

## Exemplos de Uso

### Exemplo 1: Criar Transação para Bill

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "90764fed-4ba7-4e0b-9609-68c94d7184c6",
    "type": "bills",
    "bank_account": "8d2bd953-a203-4c63-901d-75e9a93ae00a",
    "transaction_date": "2025-12-03",
    "description": "Pagamento via PIX",
    "payment_method": "uuid-do-metodo-pagamento"
  }'
```

**Resultado:**
- Transação criada com tipo `DESPESA`
- Bill atualizado para status `quitada`
- Saldo da conta bancária reduzido pelo valor do bill

### Exemplo 2: Criar Transação para Income

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-income",
    "type": "incomes",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03"
  }'
```

**Resultado:**
- Transação criada com tipo `RECEITA`
- Income atualizado para status `recebido`
- Descrição automática: `"Recebimento - {income.description}"`
- Saldo da conta bancária aumentado pelo valor do income

### Exemplo 3: Criar Transação para RecurringBillPayment

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-payment",
    "type": "recurring_bill_payments",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03"
  }'
```

**Resultado:**
- Transação criada com tipo `DESPESA`
- RecurringBillPayment atualizado para status `quitada`
- Campo `paid_on` preenchido com `transaction_date`
- Categoria, centro de custo e contato copiados do `recurring_bill` pai
- Saldo da conta bancária reduzido pelo valor do payment

### Exemplo 4: Criar Transação para RecurringIncomeReceipt

**Request:**
```bash
curl -X POST "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "uuid-do-receipt",
    "type": "recurring_income_receipts",
    "bank_account": "uuid-da-conta",
    "transaction_date": "2025-12-03",
    "description": "Recebimento antecipado"
  }'
```

**Resultado:**
- Transação criada com tipo `RECEITA`
- RecurringIncomeReceipt atualizado para status `recebido`
- Campo `received_on` preenchido com `transaction_date`
- Categoria, centro de custo e contato copiados do `recurring_income` pai
- Saldo da conta bancária aumentado pelo valor do receipt

---

## Notas Importantes

1. **Operação Atômica**: A criação da transação e atualização do item são feitas em uma transação atômica do banco de dados. Se qualquer parte falhar, tudo é revertido.

2. **Atualização Automática de Saldo**: O saldo da conta bancária é atualizado automaticamente quando a transação é criada. Não é necessário fazer chamadas adicionais.

3. **Pré-preenchimento Inteligente**: Todos os dados relevantes (categoria, centro de custo, contato, valor) são copiados automaticamente do item ou do item pai (para recurring payments/receipts), facilitando o processo de criação.

4. **Validações de Negócio**: O endpoint valida se o item pode receber uma transação (não está quitado/recebido e não possui transação existente).

5. **Descrição Padrão**: Se não fornecida, a descrição é gerada automaticamente com base no tipo e descrição do item.

6. **Suporte a Método de Pagamento**: É possível especificar um método de pagamento opcional, que será associado à transação.

7. **Resposta Completa**: A resposta inclui tanto o item atualizado quanto a transação criada, facilitando a atualização do frontend.

---

## Fluxo Completo

1. **Validação de Autenticação**: Verifica se o usuário está autenticado e pertence à empresa
2. **Validação de Dados**: Valida os campos obrigatórios e formato dos dados
3. **Busca do Item**: Busca o item financeiro pelo UUID
4. **Validação de Estado**: Verifica se o item pode receber uma transação
5. **Extração de Dados**: Extrai dados do item para pré-preencher a transação
6. **Criação da Transação**: Cria a transação com dados pré-preenchidos
7. **Atualização do Saldo**: O saldo bancário é atualizado automaticamente
8. **Atualização do Item**: Atualiza o status e associa a transação ao item
9. **Resposta**: Retorna o item atualizado com a transação criada

---

## Integração com Frontend

### Fluxo Sugerido

1. **Listar Itens Pendentes**: Usar GET `/api/v1/financials/data/?type=bills&status=a_vencer`
2. **Selecionar Item**: Usuário seleciona um item da lista
3. **Abrir Modal/Form**: Mostrar formulário com:
   - Conta bancária (dropdown)
   - Data da transação (date picker)
   - Descrição (opcional, com valor padrão)
   - Método de pagamento (opcional)
4. **Submeter POST**: Enviar requisição POST com os dados
5. **Atualizar UI**: 
   - Atualizar o item na lista (status mudou para quitada/recebido)
   - Mostrar transação criada
   - Atualizar saldo da conta bancária

### Tratamento de Erros

- **Item já quitado**: Mostrar mensagem e remover da lista de pendentes
- **Item não encontrado**: Mostrar erro e recarregar lista
- **Validação falhou**: Mostrar erros de validação nos campos correspondentes

---

## Testes

Para testar o endpoint, execute o script:
```bash
./test_financial_data_api.sh
```

O script realiza:
1. Login e obtenção de tokens
2. Listagem de bills pendentes
3. Criação de transação para um bill
4. Verificação de atualização de saldo
5. Validação de resposta

---

# API de Financial Data - Métodos PUT/PATCH

## Endpoint

**PUT/PATCH** `/api/v1/financials/data/`

Atualiza um `recurring_bill` ou `recurring_income`.

**Comportamento:**
- Parcelas pendentes futuras são atualizadas com os novos dados (ex: novo valor, nova categoria)
- Parcelas já pagas/recebidas permanecem **inalteradas** (preserva histórico)
- Se campos de agendamento forem alterados (amount, frequency, start_date, end_date, next_due_date), as parcelas são regeneradas

---

## Autenticação

Requer autenticação JWT e identificação da empresa ativa (mesma do POST).

---

## Body da Requisição

### Campos Obrigatórios

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `uuid` | UUID | UUID do recurring_bill ou recurring_income | `"90764fed-4ba7-4e0b-9609-68c94d7184c6"` |
| `type` | string | Tipo do item. Valores aceitos: `recurring_bills`, `recurring_incomes` | `"recurring_bills"` |

### Campos Editáveis (todos opcionais para PATCH, obrigatórios para PUT)

| Campo | Tipo | Descrição | Exemplo |
|-------|------|-----------|---------|
| `description` | string | Nova descrição | `"Aluguel atualizado"` |
| `amount` | decimal | Novo valor (atualiza parcelas pendentes futuras) | `1500.00` |
| `frequency` | string | Nova frequência (`daily`, `weekly`, `monthly`, `quarterly`, `yearly`) | `"monthly"` |
| `category` | UUID | UUID da nova categoria | `"uuid-da-categoria"` |
| `cost_center` | UUID | UUID do novo centro de custo | `"uuid-do-centro-custo"` |
| `contact` | UUID | UUID do novo contato | `"uuid-do-contato"` |
| `start_date` | date | Nova data de início | `"2025-01-01"` |
| `end_date` | date | Nova data de fim (ou null) | `"2025-12-31"` |
| `next_due_date` | date | Nova próxima data de vencimento | `"2025-02-01"` |
| `is_active` | boolean | Se o recorrente está ativo | `true` |

---

## Comportamento de Atualização

### Atualização de Valor (`amount`)

Quando o valor é alterado:
1. O valor do `recurring_bill`/`recurring_income` é atualizado
2. Todas as parcelas **PENDENTES** com `due_date >= hoje` são atualizadas com o novo valor
3. Parcelas já **PAGAS/RECEBIDAS** mantêm o valor original

### Atualização de Campos de Agendamento

Quando `frequency`, `start_date`, `end_date` ou `next_due_date` são alterados:
1. Parcelas **PENDENTES** futuras são **deletadas**
2. Novas parcelas são **regeneradas** com base no novo agendamento
3. Parcelas já **PAGAS/RECEBIDAS** são mantidas intactas

### Atualização de Categoria/Centro de Custo/Contato

Quando esses campos são alterados:
1. O `recurring_bill`/`recurring_income` é atualizado
2. Parcelas pendentes **NÃO são alteradas** automaticamente (elas herdam do pai na hora do pagamento)
3. Quando uma parcela for paga/recebida, ela herdará os novos valores do pai

---

## Resposta de Sucesso

**Status Code:** `200 OK`

Retorna a mesma estrutura do GET com `uuid`, incluindo resumo de pagamentos/recebimentos.

### Exemplo de Resposta - RecurringBill (PATCH)

**Request:**
```json
{
    "uuid": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
    "type": "recurring_bills",
    "amount": "750.00"
}
```

**Response (200 OK):**
```json
{
    "type": "recurring_bills",
    "item": {
        "id": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": null,
        "cost_center_name": null,
        "contact": "0c9ce895-09eb-4128-bd44-959c5616ffc9",
        "contact_name": "Cliente Exemplo LTDA",
        "order": 12,
        "order_code": "#12",
        "description": "Manutenção trimestral - Equipamentos",
        "amount": "750.00",
        "frequency": "quarterly",
        "start_date": "2025-06-06",
        "end_date": null,
        "next_due_date": "2025-12-06",
        "is_active": false,
        "created_at": "2025-12-03T15:22:45.570647-03:00",
        "updated_at": "2025-12-04T11:26:15.249335-03:00"
    },
    "payments_summary": {
        "total_payments": 7,
        "pending_count": 3,
        "paid_count": 4,
        "total_pending": 2250.0,
        "total_paid": 2000.0
    },
    "next_payments": [
        {
            "id": "9a7f0e72-0870-466c-8b1c-5f0ffd48efa2",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": "a92e5b26-071b-4d0a-8389-85974856f006",
            "due_date": "2025-12-06",
            "paid_on": "2025-12-03",
            "amount": "500.00",
            "status": "quitada",
            "created_at": "2025-12-03T15:22:45.574885-03:00",
            "updated_at": "2025-12-03T16:03:35.077167-03:00"
        },
        {
            "id": "35b45d99-f171-4ed3-b32f-093cddfafaad",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": "f0a4261b-8d83-4d03-ad4c-d34349e7d1b1",
            "due_date": "2026-03-06",
            "paid_on": "2025-12-03",
            "amount": "500.00",
            "status": "quitada",
            "created_at": "2025-12-03T15:22:45.575799-03:00",
            "updated_at": "2025-12-03T15:23:33.623025-03:00"
        },
        {
            "id": "fe67a773-75ac-489a-a1f1-670376fd8352",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": null,
            "due_date": "2026-06-06",
            "paid_on": null,
            "amount": "750.00",
            "status": "pendente",
            "created_at": "2025-12-04T11:26:15.252252-03:00",
            "updated_at": "2025-12-04T11:26:15.252257-03:00"
        },
        {
            "id": "66c3fdc0-277d-4a50-87aa-2a495c0ab235",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": null,
            "due_date": "2026-09-06",
            "paid_on": null,
            "amount": "750.00",
            "status": "pendente",
            "created_at": "2025-12-04T11:26:15.252267-03:00",
            "updated_at": "2025-12-04T11:26:15.252269-03:00"
        },
        {
            "id": "d933817b-6d84-4c1d-9c88-f3551f2fad3b",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": null,
            "due_date": "2026-12-06",
            "paid_on": null,
            "amount": "750.00",
            "status": "pendente",
            "created_at": "2025-12-04T11:26:15.252276-03:00",
            "updated_at": "2025-12-04T11:26:15.252278-03:00"
        }
    ]
}
```

**Observações:**
- Parcelas já pagas (`status: "quitada"`) mantêm o valor original (`amount: "500.00"`)
- Parcelas pendentes foram atualizadas com o novo valor (`amount: "750.00"`)
- O `payments_summary` reflete os valores atualizados

### Exemplo de Resposta - RecurringBill (PUT)

**Request:**
```json
{
    "uuid": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
    "type": "recurring_bills",
    "description": "Manutenção trimestral - Equipamentos Atualizado",
    "amount": "800.00",
    "frequency": "quarterly",
    "start_date": "2025-06-06",
    "next_due_date": "2025-12-06",
    "is_active": true
}
```

**Response (200 OK):**
```json
{
    "type": "recurring_bills",
    "item": {
        "id": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
        "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
        "company_name": "Startec Serviços e Tecnologia",
        "category": "06c55420-9fc1-442e-94ae-838e1e93fb7b",
        "category_name": "Despesas Operacionais",
        "category_code": "2",
        "cost_center": null,
        "cost_center_name": null,
        "contact": "0c9ce895-09eb-4128-bd44-959c5616ffc9",
        "contact_name": "Cliente Exemplo LTDA",
        "order": 12,
        "order_code": "#12",
        "description": "Manutenção trimestral - Equipamentos Atualizado",
        "amount": "800.00",
        "frequency": "quarterly",
        "start_date": "2025-06-06",
        "end_date": null,
        "next_due_date": "2025-12-06",
        "is_active": true,
        "created_at": "2025-12-03T15:22:45.570647-03:00",
        "updated_at": "2025-12-04T11:26:26.720772-03:00"
    },
    "payments_summary": {
        "total_payments": 7,
        "pending_count": 3,
        "paid_count": 4,
        "total_pending": 2400.0,
        "total_paid": 2000.0
    },
    "next_payments": [
        {
            "id": "9a7f0e72-0870-466c-8b1c-5f0ffd48efa2",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos Atualizado",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": "a92e5b26-071b-4d0a-8389-85974856f006",
            "due_date": "2025-12-06",
            "paid_on": "2025-12-03",
            "amount": "500.00",
            "status": "quitada",
            "created_at": "2025-12-03T15:22:45.574885-03:00",
            "updated_at": "2025-12-03T16:03:35.077167-03:00"
        },
        {
            "id": "67ce1b08-85cd-41db-aac5-e7adf4cc6b0b",
            "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
            "recurring_bill": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
            "recurring_bill_description": "Manutenção trimestral - Equipamentos Atualizado",
            "category_code": "2",
            "category_name": "Despesas Operacionais",
            "contact_name": "Cliente Exemplo LTDA",
            "transaction": null,
            "due_date": "2026-06-06",
            "paid_on": null,
            "amount": "800.00",
            "status": "pendente",
            "created_at": "2025-12-04T11:26:26.722774-03:00",
            "updated_at": "2025-12-04T11:26:26.722777-03:00"
        }
    ]
}
```

**Observações:**
- A descrição foi atualizada
- O valor foi atualizado para R$ 800,00
- Parcelas pendentes foram regeneradas com o novo valor
- Parcelas já pagas mantêm o valor original

### Exemplo de Resposta - RecurringIncome (PATCH/PUT)

A estrutura de resposta para `recurring_incomes` é similar à de `recurring_bills`, mas com os seguintes campos específicos:

- `receipts_summary` ao invés de `payments_summary`:
  ```json
  {
      "total_receipts": 12,
      "pending_count": 10,
      "received_count": 2,
      "total_pending": 15000.0,
      "total_received": 2000.0
  }
  ```

- `next_receipts` ao invés de `next_payments`:
  ```json
  [
      {
          "id": "uuid-receipt-1",
          "company": "c8ffdb92-2e9d-4bd5-aa05-c06adb85cafb",
          "recurring_income": "uuid-do-recurring-income",
          "recurring_income_description": "Assinatura Mensal",
          "category_code": "1",
          "category_name": "Vendas",
          "contact_name": "Cliente Exemplo LTDA",
          "transaction": null,
          "due_date": "2025-02-01",
          "received_on": null,
          "amount": "1500.00",
          "status": "pendente",
          "created_at": "2025-01-01T12:00:00-03:00",
          "updated_at": "2025-01-01T12:00:00-03:00"
      }
  ]
  ```

---

## Respostas de Erro

### 400 Bad Request - Tipo Não Suporta Atualização

```json
{
    "error": "Tipo 'bills' não suporta atualização.",
    "allowed_types": ["recurring_bills", "recurring_incomes"]
}
```

### 400 Bad Request - Campo UUID Ausente

```json
{
    "error": "Campo 'uuid' é obrigatório."
}
```

### 400 Bad Request - Campo Type Ausente

```json
{
    "error": "Campo 'type' é obrigatório."
}
```

### 404 Not Found - Item Não Encontrado

```json
{
    "error": "Item não encontrado com UUID: {uuid}"
}
```

---

## Exemplos de Uso

### Exemplo 1: Atualizar Valor de RecurringBill (PATCH)

**Request:**
```bash
curl -X PATCH "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
    "type": "recurring_bills",
    "amount": "750.00"
  }'
```

**Resultado:**
- Valor do recurring_bill atualizado para R$ 750,00
- Todas as parcelas pendentes futuras atualizadas para R$ 750,00
- Parcelas já pagas mantêm o valor original (R$ 500,00)
- Ver resposta completa na seção "Exemplo de Resposta - RecurringBill (PATCH)" acima

### Exemplo 2: Atualizar Descrição e Valor de RecurringBill (PUT)

**Request:**
```bash
curl -X PUT "http://localhost:8000/api/v1/financials/data/" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "049cc6af-c212-4ed0-aed4-8cb27e1c08f4",
    "type": "recurring_bills",
    "description": "Manutenção trimestral - Equipamentos Atualizado",
    "amount": "800.00",
    "frequency": "quarterly",
    "start_date": "2025-06-06",
    "next_due_date": "2025-12-06",
    "is_active": true
  }'
```

**Resultado:**
- Descrição atualizada
- Valor atualizado para R$ 800,00
- Parcelas pendentes regeneradas com o novo valor
- Parcelas já recebidas mantidas intactas
- Ver resposta completa na seção "Exemplo de Resposta - RecurringBill (PUT)" acima

---

# API de Financial Data - Método DELETE

## Endpoint

**DELETE** `/api/v1/financials/data/?uuid={uuid}&type={type}`

Remove um `recurring_bill` ou `recurring_income`.

**Comportamento:**
- Parcelas **PENDENTES** futuras são **removidas**
- Parcelas já **PAGAS/RECEBIDAS** são **mantidas** para histórico (referência ao recurring é definida como NULL)

---

## Query Parameters

| Parâmetro | Tipo | Obrigatório | Descrição |
|-----------|------|-------------|-----------|
| `uuid` | UUID | Sim | UUID do recurring_bill ou recurring_income |
| `type` | string | Sim | `recurring_bills` ou `recurring_incomes` |

---

## Comportamento de Deleção

### Para RecurringBills:
1. Parcelas com `status = pendente` e `due_date >= hoje` são **deletadas**
2. Parcelas com `status = quitada` são **mantidas** (campo `recurring_bill` vira `null`)
3. O `RecurringBill` é deletado

### Para RecurringIncomes:
1. Parcelas com `status = pendente` e `due_date >= hoje` são **deletadas**
2. Parcelas com `status = recebido` são **mantidas** (campo `recurring_income` vira `null`)
3. O `RecurringIncome` é deletado

### Preservação de Histórico

Parcelas já pagas/recebidas são mantidas porque:
- Possuem transações financeiras associadas
- Fazem parte do histórico contábil da empresa
- O campo `recurring_bill` ou `recurring_income` é definido como `NULL`, mas todos os outros dados permanecem

---

## Resposta de Sucesso

**Status Code:** `200 OK`

**Response:**
```json
{
    "message": "Item deletado com sucesso. Parcelas já pagas/recebidas foram mantidas para histórico."
}
```

**Observações:**
- O item `recurring_bill` ou `recurring_income` foi deletado
- Parcelas pendentes futuras foram removidas
- Parcelas já pagas/recebidas foram mantidas (campo `recurring_bill` ou `recurring_income` definido como `null`)

---

## Respostas de Erro

### 400 Bad Request - Tipo Não Suporta Deleção

```json
{
    "error": "Tipo 'bills' não suporta deleção via esta API.",
    "allowed_types": ["recurring_bills", "recurring_incomes"]
}
```

### 400 Bad Request - Parâmetro UUID Ausente

```json
{
    "error": "Parâmetro 'uuid' é obrigatório."
}
```

### 400 Bad Request - Parâmetro Type Ausente

```json
{
    "error": "Parâmetro 'type' é obrigatório."
}
```

### 404 Not Found - Item Não Encontrado

```json
{
    "error": "Item não encontrado com UUID: {uuid}"
}
```

---

## Exemplos de Uso

### Exemplo 1: Deletar RecurringBill

**Request:**
```bash
curl -X DELETE "http://localhost:8000/api/v1/financials/data/?uuid=049cc6af-c212-4ed0-aed4-8cb27e1c08f4&type=recurring_bills" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>"
```

**Response (200 OK):**
```json
{
    "message": "Item deletado com sucesso. Parcelas já pagas/recebidas foram mantidas para histórico."
}
```

**Resultado:**
- RecurringBill deletado
- Parcelas pendentes futuras deletadas
- Parcelas já pagas mantidas (com `recurring_bill = null`)

### Exemplo 2: Deletar RecurringIncome

**Request:**
```bash
curl -X DELETE "http://localhost:8000/api/v1/financials/data/?uuid=11b35d5c-1234-5678-9abc-def012345678&type=recurring_incomes" \
  -H "Authorization: Bearer <access_token>" \
  -H "X-Company-Id: <company_id>"
```

**Response (200 OK):**
```json
{
    "message": "Item deletado com sucesso. Parcelas já pagas/recebidas foram mantidas para histórico."
}
```

**Resultado:**
- RecurringIncome deletado
- Parcelas pendentes futuras deletadas
- Parcelas já recebidas mantidas (com `recurring_income = null`)

---

## Notas Importantes

1. **Operação Irreversível**: A deleção do recurring é permanente. Use com cuidado.

2. **Preservação de Histórico**: Parcelas já pagas/recebidas são mantidas para garantir a integridade do histórico financeiro.

3. **Invalidação de Cache**: O cache é automaticamente invalidado após a deleção.

4. **Apenas Recurring**: Este endpoint só suporta deleção de `recurring_bills` e `recurring_incomes`. Para outros tipos, use as APIs específicas.

5. **Parcelas Pendentes Passadas**: Parcelas pendentes com `due_date < hoje` **NÃO** são deletadas automaticamente. Considere quitá-las ou recebê-las antes de deletar o recurring.

